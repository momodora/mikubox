<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MikuBOX</title>
  <link rel="icon" href="favicon.png" type="image/png" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header>
    <div style="display: flex; justify-content: center; align-items: center; gap: 1em; flex-wrap: wrap;">
      <div style="display: flex; align-items: center; gap: 0.5em;">
        <img src="favicon.png" alt="图标" style="width: 32px; height: 32px;" />
        <h1 style="margin: 0;">葱葱盒</h1>
      </div>
      <input type="text" id="search" placeholder="搜索表情包关键词..." />
      <button id="randomBtn" class="tag-btn">随机一个</button>
    </div>
    <div id="tags" class="tags"></div>
  </header>
  <main>
    <div id="gallery" class="grid"></div>
  </main>
  <footer>
    <p>Powered by <a href="https://space.bilibili.com/4235377" target="_blank" rel="noopener noreferrer">未来de残像</a> · 表情包网站</p>
  </footer>

  <!-- 模态框预览 -->
  <div id="modal" class="modal" style="display: none;">
    <div class="modal-content">
      <span class="close-btn">×</span>
      <div id="modal-label" style="margin-bottom: 0.8em; font-weight: bold;"></div>
      <img id="modal-img" src="" alt="预览" />
      <div style="margin-top: 1em; text-align: center;">
        <a id="download-btn" href="#" download class="download-button">下载图片</a>
      </div>
    </div>
  </div>

  <script>
    let allImages = [];
    let activeTag = null;

    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    function renderGallery(images) {
      const container = document.getElementById('gallery');
      container.innerHTML = '';
      images.forEach(item => {
        const div = document.createElement('div');
        div.className = 'grid-item';

        const img = document.createElement('img');
        img.src = 'images/' + item.filename;
        img.alt = item.label;

        const label = document.createElement('div');
        label.className = 'label';
        label.textContent = item.label;

        div.appendChild(img);
        div.appendChild(label);
        container.appendChild(div);
      });
    }

    function renderTags(images) {
      const tagSet = new Set();
      images.forEach(img => img.tags.forEach(tag => tagSet.add(tag)));

      const tagsDiv = document.getElementById('tags');
      tagsDiv.innerHTML = '';

      const allBtn = document.createElement('button');
      allBtn.textContent = '全部';
      allBtn.className = 'tag-btn';
      allBtn.onclick = () => {
        activeTag = null;
        document.getElementById('search').value = '';
        renderGallery(allImages);
      };
      tagsDiv.appendChild(allBtn);

      tagSet.forEach(tag => {
        const btn = document.createElement('button');
        btn.textContent = tag;
        btn.className = 'tag-btn';
        btn.onclick = () => {
          activeTag = tag;
          document.getElementById('search').value = '';
          renderGallery(allImages.filter(img => img.tags.includes(tag)));
        };
        tagsDiv.appendChild(btn);
      });
    }

    function setupSearch() {
      const searchInput = document.getElementById('search');
      searchInput.addEventListener('input', () => {
        const keyword = searchInput.value.trim().toLowerCase();
        if (keyword === '') {
          renderGallery(allImages);
        } else {
          const results = allImages.filter(item =>
            item.label.toLowerCase().includes(keyword) ||
            item.tags.some(tag => tag.toLowerCase().includes(keyword))
          );
          renderGallery(results);
        }
      });
    }

    fetch('images.json')
      .then(res => res.json())
      .then(data => {
        allImages = shuffleArray(data);
        renderTags(allImages);
        renderGallery(allImages);
        setupSearch();
      });

    const modal = document.getElementById('modal');
    const modalImg = document.getElementById('modal-img');
    const modalLabel = document.getElementById('modal-label');
    const downloadBtn = document.getElementById('download-btn');
    const closeBtn = document.querySelector('.close-btn');

    document.addEventListener('click', function (e) {
      if (e.target.tagName === 'IMG' && e.target.closest('.grid-item')) {
        const src = e.target.getAttribute('src');
        const label = e.target.nextElementSibling?.textContent || '图片';

        modalImg.src = src;
        modalLabel.textContent = label;
        downloadBtn.href = src;

        modal.style.display = 'flex';
      }

      if (e.target === modal || e.target === closeBtn) {
        modal.style.display = 'none';
        modalImg.src = '';
        modalLabel.textContent = '';
        downloadBtn.href = '#';
      }
    });

    document.getElementById('randomBtn').addEventListener('click', () => {
      if (allImages.length === 0) return;

      const randomIndex = Math.floor(Math.random() * allImages.length);
      const randomImg = allImages[randomIndex];

      modalImg.src = 'images/' + randomImg.filename;
      modalLabel.textContent = randomImg.label || '';
      downloadBtn.href = 'images/' + randomImg.filename;
      modal.style.display = 'flex';
    });
  </script>

  <!--崩溃欺骗-->
  <script>
  var OriginTitile = document.title;
  var st;
  document.addEventListener('visibilitychange', function () {
    if (document.hidden) {
      document.title = "╭(°A°`)╮页面崩溃啦";
      clearTimeout(st);
    } else {
      document.title = "(ฅ>ω<*ฅ) 噫又好了~ " + OriginTitile;
      st = setTimeout(function () {
        document.title = OriginTitile;
      }, 4000);
    }
  });
  </script>

</body>
</html>
